## Activity Examples

### Daily Network Firewall Activity Trends

Count Network Firewall log entries per day to identify network activity trends. This helps monitor overall firewall activity and detect unusual spikes in traffic.

```sql
select
  strftime(event_timestamp, '%Y-%m-%d') as traffic_date,
  count(*) as log_count
from
  aws_network_firewall_log
group by
  traffic_date
order by
  traffic_date asc;
```

```yaml
folder: Network Firewall
```

### Top 10 Source IPs Generating Traffic

Identify the top 10 source IP addresses that generated the most network traffic. This helps detect potential high-traffic sources that may indicate misconfigured applications or suspicious activity.

```sql
select
  tp_source_ip,
  count(*) as log_count
from
  aws_network_firewall_log
where
  tp_source_ip is not null
group by
  tp_source_ip
order by
  log_count desc
limit 10;
```

```yaml
folder: Network Firewall
```

### Traffic Distribution by Protocol

Analyze traffic distribution by protocol to understand what types of network protocols are most frequently used in your environment.

```sql
select
  event ->> 'proto' as protocol,
  count(*) as traffic_count
from
  aws_network_firewall_log
group by
  protocol
order by
  traffic_count desc;
```

```yaml
folder: Network Firewall
```

## Detection Examples

### Identify Traffic from a Suspicious IP

Check if a specific IP is sending or receiving traffic. This is useful for investigating potential threats or monitoring known suspicious IPs.

```sql
select
  event_timestamp,
  event ->> 'src_ip' as source_ip,
  event ->> 'src_port' as source_port,
  event ->> 'dest_ip' as destination_ip,
  event ->> 'dest_port' as destination_port,
  event ->> 'proto' as protocol,
  firewall_name
from
  aws_network_firewall_log
where
  event ->> 'src_ip' = '192.0.2.100'
  or event ->> 'dest_ip' = '192.0.2.100'
order by
  event_timestamp desc;
```

```yaml
folder: Network Firewall
```

### Detect Potentially Suspicious DNS Traffic

Identify DNS traffic that might indicate command and control (C2) communications or data exfiltration attempts over DNS.

```sql
select
  event_timestamp,
  event ->> 'src_ip' as source_ip,
  event ->> 'dest_ip' as destination_ip,
  event ->> 'dest_port' as destination_port,
  event ->> 'proto' as protocol,
  firewall_name
from
  aws_network_firewall_log
where
  event ->> 'app_proto' = 'dns'
  and event ->> 'dest_port' = '53'
  and event ->> 'proto' = 'UDP'
order by
  event_timestamp desc;
```

```yaml
folder: Network Firewall
```

### Monitor Network Firewall Alerts

Identify and analyze alert events generated by the Network Firewall. This helps monitor security rules and detect potential threats.

```sql
select
  event_timestamp,
  event ->> 'src_ip' as source_ip,
  event ->> 'dest_ip' as destination_ip,
  event ->> 'alert' ->> 'action' as alert_action,
  event ->> 'alert' ->> 'signature' as alert_signature,
  event ->> 'alert' ->> 'severity' as alert_severity,
  event ->> 'alert' ->> 'category' as alert_category,
  firewall_name
from
  aws_network_firewall_log
where
  event ->> 'alert' is not null
order by
  event_timestamp desc;
```

```yaml
folder: Network Firewall
```

## Operational Examples

### Monitor Traffic Through Specific Firewall

Retrieve network traffic flows through a specific Network Firewall. This helps analyze firewall behavior and troubleshoot connectivity issues.

```sql
select
  event_timestamp,
  event ->> 'src_ip' as source_ip,
  event ->> 'src_port' as source_port,
  event ->> 'dest_ip' as destination_ip,
  event ->> 'dest_port' as destination_port,
  event ->> 'proto' as protocol,
  event ->> 'app_proto' as app_protocol,
  availability_zone
from
  aws_network_firewall_log
where
  firewall_name = 'main-firewall'
order by
  event_timestamp desc
limit 100;
```

```yaml
folder: Network Firewall
```

### Netflow Traffic Analysis

Analyze netflow data to understand traffic patterns, including bytes transferred and packet counts.

```sql
select
  event_timestamp,
  event ->> 'src_ip' as source_ip,
  event ->> 'dest_ip' as destination_ip,
  event ->> 'proto' as protocol,
  event ->> 'netflow' ->> 'bytes' as bytes,
  event ->> 'netflow' ->> 'packets' as packets,
  event ->> 'netflow' ->> 'start_time' as start_time,
  event ->> 'netflow' ->> 'end_time' as end_time,
  firewall_name
from
  aws_network_firewall_log
where
  event ->> 'event_type' = 'netflow'
  and event ->> 'netflow' is not null
order by
  event_timestamp desc
limit 100;
```

```yaml
folder: Network Firewall
```

### TLS Connection Analysis

Monitor TLS connections and any related errors to identify potential SSL/TLS issues or suspicious encrypted traffic.

```sql
select
  event_timestamp,
  event ->> 'src_ip' as source_ip,
  event ->> 'dest_ip' as destination_ip,
  event ->> 'sni' as server_name_indication,
  event ->> 'tls_inspected' as tls_inspected,
  event ->> 'tls_error' ->> 'error_message' as tls_error,
  firewall_name
from
  aws_network_firewall_log
where
  event ->> 'app_proto' = 'tls'
order by
  event_timestamp desc;
```

```yaml
folder: Network Firewall
```

## Volume Examples

### Unusually Large Data Transfers

Identify unusually large data transfers based on bytes transferred. This helps detect potential data exfiltration or abnormal network usage.

```sql
select
  event_timestamp,
  event ->> 'src_ip' as source_ip,
  event ->> 'dest_ip' as destination_ip,
  event ->> 'netflow' ->> 'bytes' as bytes,
  event ->> 'netflow' ->> 'packets' as packets,
  event ->> 'proto' as protocol,
  firewall_name
from
  aws_network_firewall_log
where
  (event ->> 'netflow' ->> 'bytes')::bigint > 1000000 -- 1MB
order by
  bytes desc;
```

```yaml
folder: Network Firewall
```

### High-Volume Network Traffic by Source IP

Find network sources generating a high number of connections, which helps detect possible denial-of-service (DoS) attacks or heavy application usage.

```sql
select
  event ->> 'src_ip' as source_ip,
  count(*) as connection_count,
  date_trunc('hour', event_timestamp) as traffic_hour
from
  aws_network_firewall_log
where
  event ->> 'src_ip' is not null
group by
  source_ip,
  traffic_hour
having
  count(*) > 50
order by
  connection_count desc;
```

```yaml
folder: Network Firewall
```

### Destination Port Usage Analysis

Analyze traffic by destination port to understand which services are most frequently accessed across your network.

```sql
select
  event ->> 'dest_port' as destination_port,
  event ->> 'app_proto' as app_protocol,
  count(*) as connection_count
from
  aws_network_firewall_log
where
  event ->> 'dest_port' is not null
group by
  destination_port,
  app_protocol
order by
  connection_count desc
limit 20;
```

```yaml
folder: Network Firewall
```
